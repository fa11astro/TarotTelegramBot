import os
import random
from datetime import datetime
from typing import Dict, List

from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import Application, CommandHandler, ContextTypes

# –ö–∞—Ä—Ç–∞ –¢–∞—Ä–æ —Å –±–∞–∑–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —Å—Ñ–µ—Ä–∞–º
TarotCard = Dict[str, str]


TAROT_DECK: List[TarotCard] = [
    {
        "name": "–®—É—Ç",
        "general": "–ù–∞—á–∞–ª–æ –ø—É—Ç–∏, —Å–≤–æ–±–æ–¥–∞, –¥–æ–≤–µ—Ä–∏–µ –º–∏—Ä—É, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Ä–∏—Å–∫–Ω—É—Ç—å.",
        "love": "–õ—ë–≥–∫–æ—Å—Ç—å, —Ñ–ª–∏—Ä—Ç, –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞, –æ—Ç–Ω–æ—à–µ–Ω–∏—è –±–µ–∑ —Ç—è–∂–µ—Å—Ç–∏ –æ–∂–∏–¥–∞–Ω–∏–π.",
        "work": "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ —Ä–∞–±–æ—Ç–∞, –æ–±—É—á–µ–Ω–∏–µ, –ø—Ä–æ–±–∞ —Å–µ–±—è –≤ –Ω–æ–≤–æ–π —Ä–æ–ª–∏.",
        "finance": "–ù–µ–±–æ–ª—å—à–∏–µ —Ç—Ä–∞—Ç—ã –Ω–∞ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è, –≤–∞–∂–Ω–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å —Å —Ä–∏—Å–∫–æ–º.",
        "advice": "–ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –±—ã—Ç—å –ª—é–±–æ–ø—ã—Ç–Ω–æ–π –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π, –Ω–æ –Ω–µ —Ç–µ—Ä—è–π –æ—â—É—â–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.",
    },
    {
        "name": "–ú–∞–≥",
        "general": "–°–∏–ª–∞ –≤–æ–ª–∏, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞, —É–º–µ–Ω–∏–µ –≤–ª–∏—è—Ç—å –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é.",
        "love": "–ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞, —É—Ö–∞–∂–∏–≤–∞–Ω–∏—è, –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
        "work": "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏, –±—Ä–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É, –≥–æ–≤–æ—Ä–∏—Ç—å –æ —Å–µ–±–µ.",
        "finance": "–ï—Å—Ç—å —Ä–µ—Å—É—Ä—Å—ã, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–µ ‚Äî –≤–∞–∂–Ω–æ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è.",
        "advice": "–ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ —Ç–∞–ª–∞–Ω—Ç—ã –∏ –Ω–µ –∂–¥–∏, —á—Ç–æ –∫—Ç–æ‚Äë—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π —à–∞–≥ –∑–∞ —Ç–µ–±—è.",
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞",
        "general": "–†–æ—Å—Ç, –∏–∑–æ–±–∏–ª–∏–µ, –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ –∏ –¥—Ä—É–≥–∏—Ö, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ.",
        "love": "–¢—ë–ø–ª—ã–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –∂–µ–ª–∞–Ω–∏–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —É—é—Ç –∏ —Å–µ–º—å—é.",
        "work": "–ü—Ä–æ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–æ—Å—è—Ç –ø–ª–æ–¥; —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤ –¥–æ–ª–≥—É—é.",
        "finance": "–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç, –ø—Ä–∏—è—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã, –≤–ª–æ–∂–µ–Ω–∏—è –≤ –∫–æ–º—Ñ–æ—Ä—Ç –∏ –∫—Ä–∞—Å–æ—Ç—É.",
        "advice": "–†–∞–∑—Ä–µ—à–∏ —Å–µ–±–µ –ø–æ–ª—É—á–∞—Ç—å –∏ –Ω–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è, –Ω–æ –ø–æ–º–Ω–∏ –∏ –ø—Ä–æ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.",
    },
    {
        "name": "–°–∏–ª–∞",
        "general": "–ú—è–≥–∫–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞, –≤—ã–¥–µ—Ä–∂–∫–∞, –ø—Ä–∏–Ω—è—Ç–∏–µ —Å–≤–æ–∏—Ö —ç–º–æ—Ü–∏–π.",
        "love": "–¢–µ—Ä–ø–µ–Ω–∏–µ –∏ –∑–∞–±–æ—Ç–∞, —É–º–µ–Ω–∏–µ –Ω–µ –¥–∞–≤–∏—Ç—å, –∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
        "work": "–°–ø–æ–∫–æ–π–Ω–æ–µ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ; –Ω–µ –ø–æ–±–µ–¥–∞ —Å–∏–ª–æ–π, –∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é.",
        "finance": "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É, —É–º–µ–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–∞–≤–∞—Ç—å—Å—è –∏–º–ø—É–ª—å—Å–∞–º.",
        "advice": "–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –±–æ—Ä–æ—Ç—å—Å—è —Å —Å–æ–±–æ–π, –æ–±–Ω–∏–º–∏ —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏ –∂–µ–ª–∞–Ω–∏—è.",
    },
    {
        "name": "–°–º–µ—Ä—Ç—å",
        "general": "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä–æ–µ.",
        "love": "–ü–µ—Ä–µ–ª–æ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö: –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–≤—è–∑–∏.",
        "work": "–°–º–µ–Ω–∞ —Ä–∞–±–æ—Ç—ã, —Ä–æ–ª–∏ –∏–ª–∏ –ø–æ–¥—Ö–æ–¥–∞; –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ä–∞–¥–∏ –Ω–æ–≤—ã—Ö.",
        "finance": "–ü–µ—Ä–µ—Å–º–æ—Ç—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫, –æ—Ç–∫–∞–∑ –æ—Ç –ª–∏—à–Ω–µ–≥–æ, —Å–º–µ–Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤.",
        "advice": "–ü–æ–∑–≤–æ–ª—å —á–µ–º—É‚Äë—Ç–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å –º–µ—Å—Ç–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ.",
    },
    {
        "name": "–°–æ–ª–Ω—Ü–µ",
        "general": "–†–∞–¥–æ—Å—Ç—å, —è—Å–Ω–æ—Å—Ç—å, —É—Å–ø–µ—Ö, —Å–æ—Å—Ç–æ—è–Ω–∏–µ ¬´—è –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–µ¬ª.",
        "love": "–¢—ë–ø–ª—ã–µ, –∏—Å–∫—Ä–µ–Ω–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –º–Ω–æ–≥–æ —Å–≤–µ—Ç–∞ –∏ –≤–∑–∞–∏–º–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.",
        "work": "–£—Å–ø–µ—Ö, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ, —è—Å–Ω–æ—Å—Ç—å —Ü–µ–ª–µ–π, —Ö–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è —è—Ä–∫–æ.",
        "finance": "–£–ª—É—á—à–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–∏—è—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã –∏ –ø–æ–¥–∞—Ä–∫–∏.",
        "advice": "–ó–∞–º–µ—Ç—å, —á—Ç–æ —É–∂–µ —Ö–æ—Ä–æ—à–æ –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏, –∏ –ø–æ–∑–≤–æ–ª—å —Å–µ–±–µ —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è —ç—Ç–æ–º—É.",
    },
    # –ü—Ä–∏–º–µ—Ä—ã –º–ª–∞–¥—à–∏—Ö –∞—Ä–∫–∞–Ω–æ–≤ ‚Äî –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å –ø–æ –∂–µ–ª–∞–Ω–∏—é
    {
        "name": "–¢—É–∑ –ö—É–±–∫–æ–≤",
        "general": "–ù–æ–≤—ã–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, –ø—Ä–∏–ª–∏–≤ —á—É–≤—Å—Ç–≤.",
        "love": "–ù–∞—á–∞–ª–æ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å —Å–µ—Ä–¥—Ü—É.",
        "work": "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç, –¥–µ–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏.",
        "finance": "–ù–µ–±–æ–ª—å—à–∏–µ, –Ω–æ –ø—Ä–∏—è—Ç–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, —Ä–∞–¥–æ—Å—Ç—å –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–µ–Ω—å–≥–∏.",
        "advice": "–ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ —Å–≤–æ–∏–º —á—É–≤—Å—Ç–≤–∞–º ‚Äî –æ–Ω–∏ —Å–µ–π—á–∞—Å —á–µ—Å—Ç–Ω—ã–π –∫–æ–º–ø–∞—Å.",
    },
    {
        "name": "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
        "general": "–®–∞–Ω—Å –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ, –ø–æ—á–≤–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–æ—Å—Ç–∞.",
        "love": "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —á—Ç–æ‚Äë—Ç–æ —É—Å—Ç–æ–π—á–∏–≤–æ–µ –∏ –Ω–∞–¥—ë–∂–Ω–æ–µ –≤ –ø–∞—Ä–µ.",
        "work": "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –∏–¥–µ—è, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
        "finance": "–°—Ç–∞—Ä—Ç —á–µ–≥–æ‚Äë—Ç–æ –ø—Ä–∏–±—ã–ª—å–Ω–æ–≥–æ, —É–¥–∞—á–Ω–æ–µ –≤–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–∫—É–ø–∫–∞.",
        "advice": "–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —à–∞–Ω—Å—ã –≤–æ–∫—Ä—É–≥ ‚Äî –∏—Ö –º–æ–∂–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
    },
]

TOKEN = os.environ.get("BOT_TOKEN")


def _main_keyboard() -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        [
            ["üÉè –ö–∞—Ä—Ç–∞ –¥–Ω—è", "üîÆ –¢—Ä–∏ –∫–∞—Ä—Ç—ã"],
            ["‚ù§Ô∏è –ù–∞ –ª—é–±–æ–≤—å", "üíº –ù–∞ —Ä–∞–±–æ—Ç—É"],
            ["üóì –ù–∞ –º–µ—Å—è—Ü", "‚öñÔ∏è –í—ã–±–æ—Ä"],
        ],
        resize_keyboard=True,
    )


def _log_spread(spread_type: str, user, cards: List[TarotCard], question: str | None = None) -> None:
    """–õ–æ–≥–∏—Ä—É–µ–º —Ä–∞—Å–∫–ª–∞–¥—ã –≤ —Ñ–∞–π–ª spreads.log –¥–ª—è –∞–≤—Ç–æ—Ä–∞ –±–æ—Ç–∞."""
    username = f"@{user.username}" if user and user.username else "–±–µ–∑ username"
    user_id = user.id if user else "unknown"
    card_names = ", ".join(card["name"] for card in cards)

    line = (
        f"[{datetime.utcnow().isoformat()}] "
        f"type={spread_type}; user_id={user_id}, {username}; "
        f"cards=[{card_names}]"
    )
    if question:
        line += f"; question={question}"
    line += "\n"

    try:
        with open("spreads.log", "a", encoding="utf-8") as f:
            f.write(line)
    except Exception:
        # –ï—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –±–æ—Ç–∞
        pass


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –∫–∞—Ä—Ç –¢–∞—Ä–æ.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:\n"
        "üÉè –ö–∞—Ä—Ç–∞ –¥–Ω—è ‚Äî –æ–±—â–∏–π —Å–æ–≤–µ—Ç –Ω–∞ —Å–µ–π—á–∞—Å.\n"
        "üîÆ –¢—Ä–∏ –∫–∞—Ä—Ç—ã ‚Äî –ø—Ä–æ—à–ª–æ–µ / –Ω–∞—Å—Ç–æ—è—â–µ–µ / –±—É–¥—É—â–µ–µ.\n"
        "‚ù§Ô∏è –ù–∞ –ª—é–±–æ–≤—å ‚Äî –∫–∞—Ä—Ç–∞ –ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n"
        "üíº –ù–∞ —Ä–∞–±–æ—Ç—É ‚Äî –∫–∞—Ä—Ç–∞ –ø—Ä–æ –∫–∞—Ä—å–µ—Ä—É –∏ –¥–µ–Ω—å–≥–∏.\n"
        "üóì –ù–∞ –º–µ—Å—è—Ü ‚Äî –æ–±—â–∏–π —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü.\n"
        "‚öñÔ∏è –í—ã–±–æ—Ä ‚Äî —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –≤—ã–±–æ—Ä –º–µ–∂–¥—É –¥–≤—É–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏.\n\n"
        "–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã: "
        "/card, /three, /love, /work, /month, /situation, /choice."
    )
    await update.message.reply_text(text, reply_markup=_main_keyboard())


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "‚ú® –ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É –¢–∞—Ä–æ\n\n"
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "‚Ä¢ /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é.\n"
        "‚Ä¢ /card ‚Äî –∫–∞—Ä—Ç–∞ –¥–Ω—è, –æ–±—â–∏–π —Å–æ–≤–µ—Ç.\n"
        "‚Ä¢ /three ‚Äî —Ä–∞—Å–∫–ª–∞–¥: –ø—Ä–æ—à–ª–æ–µ / –Ω–∞—Å—Ç–æ—è—â–µ–µ / –±—É–¥—É—â–µ–µ.\n"
        "‚Ä¢ /love ‚Äî –∫–∞—Ä—Ç–∞ –Ω–∞ –ª—é–±–æ–≤—å –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n"
        "‚Ä¢ /work ‚Äî –∫–∞—Ä—Ç–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É –∏ —Ñ–∏–Ω–∞–Ω—Å—ã.\n"
        "‚Ä¢ /month ‚Äî –æ–±—â–∏–π —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –º–µ—Å—è—Ü.\n"
        "‚Ä¢ /situation ‚Äî —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é (—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç / –ø—Ä–∏—á–∏–Ω–∞ / —Å–æ–≤–µ—Ç).\n"
        "‚Ä¢ /choice ‚Äî —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –≤—ã–±–æ—Ä –º–µ–∂–¥—É –¥–≤—É–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏.\n"
        "‚Ä¢ /feedback <—Ç–µ–∫—Å—Ç> ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä—É.\n\n"
        "–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è."
    )
    await update.message.reply_text(text)


async def card(update: Update, context: ContextTypes.DEFAULT_TYPE):
    card = random.choice(TAROT_DECK)
    _log_spread("card_day", update.effective_user, [card])
    text = (
        "üÉè –ö–∞—Ä—Ç–∞ –¥–Ω—è\n\n"
        f"{card['name']}\n\n"
        f"–û–±—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {card['general']}\n"
        f"–°–æ–≤–µ—Ç: {card['advice']}"
    )
    await update.message.reply_text(text)


async def three(update: Update, context: ContextTypes.DEFAULT_TYPE):
    cards = random.sample(TAROT_DECK, k=3)
    positions = ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"]

    lines = ["üîÆ –†–∞—Å–∫–ª–∞–¥: –ø—Ä–æ—à–ª–æ–µ / –Ω–∞—Å—Ç–æ—è—â–µ–µ / –±—É–¥—É—â–µ–µ\n"]
    for pos, card in zip(positions, cards):
        lines.append(f"{pos}: {card['name']} ‚Äî {card['general']}")

    _log_spread("three_cards", update.effective_user, cards)
    await update.message.reply_text("\n".join(lines))


async def love(update: Update, context: ContextTypes.DEFAULT_TYPE):
    card = random.choice(TAROT_DECK)
    _log_spread("love", update.effective_user, [card])
    text = (
        "‚ù§Ô∏è –†–∞—Å–∫–ª–∞–¥ –Ω–∞ –ª—é–±–æ–≤—å –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è\n\n"
        f"–ö–∞—Ä—Ç–∞: {card['name']}\n\n"
        f"–í –ª—é–±–≤–∏: {card['love']}\n\n"
        "–°–º–æ—Ç—Ä–∏ –Ω–∞ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É —á—É–≤—Å—Ç–≤, –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç–∏ –∏ –¥–æ–≤–µ—Ä–∏—è."
    )
    await update.message.reply_text(text)


async def work(update: Update, context: ContextTypes.DEFAULT_TYPE):
    card = random.choice(TAROT_DECK)
    _log_spread("work", update.effective_user, [card])
    text = (
        "üíº –†–∞—Å–∫–ª–∞–¥ –Ω–∞ —Ä–∞–±–æ—Ç—É –∏ —Ñ–∏–Ω–∞–Ω—Å—ã\n\n"
        f"–ö–∞—Ä—Ç–∞: {card['name']}\n\n"
        f"–í —Ä–∞–±–æ—Ç–µ: {card['work']}\n"
        f"–§–∏–Ω–∞–Ω—Å—ã: {card['finance']}\n\n"
        "–°–º–æ—Ç—Ä–∏ –Ω–∞ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –∫–∞—Ä—å–µ—Ä—ã, –ø—Ä–æ–µ–∫—Ç–æ–≤, –¥–µ–Ω–µ–≥ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–±—è."
    )
    await update.message.reply_text(text)


async def feedback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–±–æ—Ä —Ñ–∏–¥–±—ç–∫–∞: /feedback –≤–∞—à —Ç–µ–∫—Å—Ç"""
    if not context.args:
        await update.message.reply_text(
            "–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, –Ω–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É —Ç–∞–∫:\n"
            "/feedback –æ—á–µ–Ω—å –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Ä–∞—Å–∫–ª–∞–¥, —Ö–æ—á—É –±–æ–ª—å—à–µ –ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è üíï"
        )
        return

    feedback_text = " ".join(context.args)
    user = update.effective_user
    username = f"@{user.username}" if user and user.username else "–±–µ–∑ username"
    user_id = user.id if user else "unknown"

    line = (
        f"[{datetime.utcnow().isoformat()}] "
        f"user_id={user_id}, {username}: {feedback_text}\n"
    )

    try:
        with open("feedbacks.txt", "a", encoding="utf-8") as f:
            f.write(line)
        await update.message.reply_text(
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! üåô –Ø –ø–µ—Ä–µ–¥–∞–º –µ–≥–æ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞."
        )
    except Exception:
        await update.message.reply_text(
            "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤, –Ω–æ —Å–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–ø—ã—Ç–∫—É üíú"
        )


async def month(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—â–∏–π —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü."""
    cards = random.sample(TAROT_DECK, k=4)
    positions = ["–¢–µ–º–∞ –º–µ—Å—è—Ü–∞", "–ì–ª–∞–≤–Ω—ã–π –≤—ã–∑–æ–≤", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞", "–†–µ–∑—É–ª—å—Ç–∞—Ç / –∏—Ç–æ–≥–∏"]

    lines = ["üóì –†–∞—Å–∫–ª–∞–¥ –Ω–∞ –º–µ—Å—è—Ü\n"]
    for pos, card in zip(positions, cards):
        lines.append(f"{pos}: {card['name']} ‚Äî {card['general']}")

    _log_spread("month", update.effective_user, cards)
    await update.message.reply_text("\n".join(lines))


async def situation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–∞—Å–∫–ª–∞–¥ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é: —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç / –ø—Ä–∏—á–∏–Ω–∞ / —Å–æ–≤–µ—Ç."""
    cards = random.sample(TAROT_DECK, k=3)
    positions = ["–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç", "–ü—Ä–∏—á–∏–Ω–∞ / –∫–æ—Ä–µ–Ω—å", "–°–æ–≤–µ—Ç"]

    question = " ".join(context.args) if context.args else None

    lines = ["üåÄ –†–∞—Å–∫–ª–∞–¥ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é\n"]
    if question:
        lines.append(f"–í–æ–ø—Ä–æ—Å: {question}\n")

    for pos, card in zip(positions, cards):
        lines.append(f"{pos}: {card['name']} ‚Äî {card['general']}")

    _log_spread("situation", update.effective_user, cards, question=question)
    await update.message.reply_text("\n".join(lines))


async def choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–∞—Å–∫–ª–∞–¥ –Ω–∞ –≤—ã–±–æ—Ä –º–µ–∂–¥—É –¥–≤—É–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏."""
    if len(context.args) >= 2:
        # —É—Å–ª–æ–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: /choice –í–∞—Ä–∏–∞–Ω—Ç_A / –í–∞—Ä–∏–∞–Ω—Ç_B
        raw = " ".join(context.args)
        parts = [p.strip() for p in raw.split("/") if p.strip()]
        option_a = parts[0] if len(parts) >= 1 else "–í–∞—Ä–∏–∞–Ω—Ç A"
        option_b = parts[1] if len(parts) >= 2 else "–í–∞—Ä–∏–∞–Ω—Ç B"
    else:
        option_a = "–í–∞—Ä–∏–∞–Ω—Ç A"
        option_b = "–í–∞—Ä–∏–∞–Ω—Ç B"

    cards = random.sample(TAROT_DECK, k=3)
    card_a, card_b, advice_card = cards

    lines = [
        "‚öñÔ∏è –†–∞—Å–∫–ª–∞–¥ –Ω–∞ –≤—ã–±–æ—Ä\n",
        f"{option_a}: {card_a['name']} ‚Äî {card_a['general']}",
        f"{option_b}: {card_b['name']} ‚Äî {card_b['general']}",
        "",
        f"–°–æ–≤–µ—Ç: {advice_card['name']} ‚Äî {advice_card['advice']}",
    ]

    question = " ".join(context.args) if context.args else None
    _log_spread("choice", update.effective_user, cards, question=question)
    await update.message.reply_text("\n".join(lines))


def main():
    if not TOKEN:
        raise RuntimeError("–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN")

    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("card", card))
    app.add_handler(CommandHandler("three", three))
    app.add_handler(CommandHandler("love", love))
    app.add_handler(CommandHandler("work", work))
    app.add_handler(CommandHandler("feedback", feedback))
    app.add_handler(CommandHandler("month", month))
    app.add_handler(CommandHandler("situation", situation))
    app.add_handler(CommandHandler("choice", choice))

    app.run_polling()


if __name__ == "__main__":
    main()

